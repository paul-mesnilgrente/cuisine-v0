{% extends '::base.html.twig' %}

{% block title %}{{ action }} une recette{% endblock %}

{% form_theme form _self %}

{% block quantite_ingredient_recette_widget %}
  <div class="form-inline">
    <div class="form-group">{{ form_widget(form.ingredient) }}</div>
    <div class="form-group">{{ form_widget(form.quantite) }}</div>
    <div class="form-group">{{ form_widget(form.unite) }}</div>
  </div>
{% endblock %}

{% block body %}
  <h1>{{ action }} une recette</h1>

  {{ form_start(form) }}
  <div class="form-inline">
    {{ form_row(form.nom) }}
    {{ form_row(form.note) }}
  </div>
  

  <div class="form-group">
    {{ form_label(form.etapes) }}
    {{ form_errors(form.etapes) }}

    <ul class="liste_etape list-unstyled"
      data-prototype="{{ form_widget(form.etapes.vars.prototype)|e('html_attr') }}">
      {% for etape in form.etapes %}
        <li>
          {{ form_errors(etape) }}
          {{ form_widget(etape) }}
        </li>
      {% endfor %}
    </ul>
    <a href="#" class="btn btn-info" id="lien_ajouter_etape">Ajouter une étape</a>
  </div>

  <div class="form-group">
    {{ form_label(form.ingredients) }}
    {{ form_errors(form.ingredients) }}
    <ul id="liste_ingredient" class="list-unstyled"
      data-prototype="{{ form_widget(form.ingredients.vars.prototype)|e }}">
      {% for ingredient in form.ingredients %}
        <li>
          {{ form_widget(ingredient) }}
        </li>
      {% endfor %}
    </ul>
  </div>

  <div class="row">
    <div class="col-md-6">{{ form_row(form.categorieRecette) }}</div>
    <div class="col-md-6">{{ form_row(form.tags) }}</div>
  </div>
  <input type="submit" value="Valider" class="btn btn-primary"/>
  {{ form_end(form) }}

{% endblock %}

{% block javascripts %}
  {{ parent() }}

  <script type="text/javascript">
    var $collectionHolder;

    // setup an "add a tag" link
    var $ajouterLienIngredient = $('<a href="#" class="lien_ajouter_ingredient btn btn-info">Ajouter un ingrédient</a>');
    var $newLinkLi = $('<li></li>').append($ajouterLienIngredient);

    jQuery(document).ready(function() {

      // Get the ul that holds the collection of tags
      $collectionHolder = $('#liste_ingredient');

      $collectionHolder.find('li').each(function() {
        ajouterLienSupprimerIngredient($(this));
      });

      // add the "add a tag" anchor and li to the tags ul
      $collectionHolder.append($newLinkLi);

      // count the current form inputs we have (e.g. 2), use that as the new
      // index when inserting a new item (e.g. 2)
      $collectionHolder.data('index', $collectionHolder.find(':input').length);

      
      $ajouterLienIngredient.on('click', function(e) {
        // prevent the link from creating a "#" on the URL
        e.preventDefault();

        // add a new tag form (see next code block)
        ajouterFormulaireIngredient($collectionHolder, $newLinkLi);
      });
    });

    function ajouterFormulaireIngredient($collectionHolder, $newLinkLi) {
        // Get the data-prototype explained earlier
        var prototype = $collectionHolder.data('prototype');

        // get the new index
        var index = $collectionHolder.data('index');

        // Replace '__name__' in the prototype's HTML to
        // instead be a number based on how many items we have
        var newForm = prototype.replace(/__name__/g, index);

        // increase the index with one for the next item
        $collectionHolder.data('index', index + 1);

        // Display the form in the page in an li, before the "Add a tag" link li
        var $newFormLi = $('<li></li>').append(newForm);
        $newLinkLi.before($newFormLi);

        ajouterLienSupprimerIngredient($newFormLi);
      }

      function ajouterLienSupprimerIngredient($tagFormLi) {
        var $removeFormA = $('<a href="#" class="supprimer_ingredient btn btn-danger">Supprimer</a>');
        $tagFormLi.append($removeFormA);

        $removeFormA.on('click', function(e) {
          // prevent the link from creating a "#" on the URL
          e.preventDefault();

          // remove the li for the tag form
          $tagFormLi.remove();
        });
      }
  </script>
{% endblock %}
